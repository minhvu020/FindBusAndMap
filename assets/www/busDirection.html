<!doctype html>
<html>
   <head>
        <title>Find Road</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        
        <link rel="stylesheet" href="http://code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.min.css" />
        <script src="http://code.jquery.com/jquery-1.8.2.min.js"></script>
        <script src="http://code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.min.js"></script>
        <script type="text/javascript" src="http://maps.google.com/maps/api/js?v=3&sensor=false&language=en"></script>
        <script type="text/javascript">
 			
 		       
        
        var distance = 0.0;
        var duration = 0;
        var busName;
        var aorb, id, ben;
        var db;
        var benDiQua = [];
        var address = [];
        var lats = [];
        var longs = [];
        var stops = [];
        var map,
                currentPosition,
                directionsDisplay, 
                directionsService;

            $(document).live("pagebeforeshow", "#map_page", function() {
                 
                    db = window.openDatabase("DemoDB", "1.0", "DemoDB", 1000000); 
			    	
			    	getBusId();

     				db.transaction(getBus, transaction_errorxx);
     				
     				navigator.geolocation.getCurrentPosition(locSuccess, locError);
     				
     				
            });
            
			//--------------------Initial Map-----------------
            function locError(error) {
                // initialize map with a static predefined latitude, longitude
               initialize(59.3426606750, 18.0736160278);
            }

            function locSuccess(position) {
                initialize(position.coords.latitude, position.coords.longitude);
            }

            function initialize(lat, lon)
            {
                directionsDisplay = new google.maps.DirectionsRenderer(); 
                directionsService = new google.maps.DirectionsService();

                currentPosition = new google.maps.LatLng(lat, lon);

                map = new google.maps.Map(document.getElementById('map_canvas'), {
                   zoom: 13,
                   center: currentPosition,
                   mapTypeId: google.maps.MapTypeId.ROADMAP
                 });
                 
                directionsDisplay.setMap(map);

                 var currentPositionMarker = new google.maps.Marker({
                    position: currentPosition,
                    map: map,
                    title: "Current position"
                });

                var infowindow = new google.maps.InfoWindow();
                google.maps.event.addListener(currentPositionMarker, 'click', function() {
                    infowindow.setContent("Current position: latitude: " + lat +" longitude: " + lon);
                    infowindow.open(map, currentPositionMarker);
                });
            }

            $(document).on('click', '#directions-button', function(e){
                e.preventDefault();
				addLongLatToBusStop();				
				showDirection();
               
            });
            
			//--------------------Get Bus Info form List Bus-----------------
			
	        function getBusId() {
	
			 var z = location.toString().indexOf('#');
			
			//bat dau tim tu day
			var mySearch = location.toString().substr(z+1);	
					
			//End A OR B
			var x = mySearch.toString().indexOf('@');

			// Khởi tạo các đối tượng
			aorb = mySearch.toString().substr(0, x);
			id = mySearch.toString().substr(x + 1);
			
			if(id<10)
			{
				ben = aorb +"_0" + id;
			}
			else
			{
				ben = aorb +"_" + id;
			}
			
			// Get info of Bus
     	    db.transaction(getBusInfo, transaction_errorInfo);
		}
		
		//--------------------Get Bus Info-----------------


		function getBusInfo(tx) {
			
				var sql = "select BUS.BusName, BUS.SpacingTime, BUS.Uptime, BUS.NTrip from BUS where BUS._id=:ma";
							
				tx.executeSql(sql, [id], getBusInfo_success);
			}

		function transaction_errorInfo(tx, error) {
			alert("Database Bus Info: " + error);
		}

		function getBusInfo_success(tx, results) 
		{	
								
		   var data = results.rows.item(0);
		   var luot;
		   
		   if(aorb=="A")
		   {
				luot = "Lượt đi";
		   }else{
				luot = "Lượt về";
		   }

			document.getElementById('directions').innerHTML += "<b>Tuyến</b>: "+data.BusName +" ("+ luot +")"+ "<br>" +
			"<b>"+data.SpacingTime + "</b><br>" +
			"<b>Giờ hoạt động</b>: "+data.Uptime + "<br>" +
			"<b>Số chuyến</b>: " + data.NTrip + "<br>";
		}
		
		//--------------------Get List BusStop-----------------
		
function getBus(tx) {
	
		var sql = "select DATA.BenDiQua from DATA where DATA.MaTuyen=:ma";
					
		tx.executeSql(sql, [ben], getBus_success);
	}

	function transaction_errorxx(tx, error) {
	    alert("Database DATA Error: " + error);
	}

	function getBus_success(tx, results) 
	{	
	    var len = results.rows.length;
	    for (var i=0; i<len; i++) {	    			
			var data = results.rows.item(i);	
			benDiQua.push(data.BenDiQua);	 	
	    }	

	   db.transaction(getBusAttribute, transaction_error2);    
		
	}
	
	function transaction_error2(tx, error) {
	    alert("Database Error 2 : " + error);
	}
	
	 function getBusAttribute(tx) {
		var sql = "select BUSSTOP.Address, BUSSTOP.Latitude, BUSSTOP.Longitude" +
		" from BUSSTOP where BUSSTOP._id=:id";

		for(var i = 0; i < benDiQua.length; i++)
		{			
			tx.executeSql(sql,[benDiQua[i]], getBus_success2);
				
		}

	}      
	
	function getBus_success2(tx, results) 
	{	
		var bus = results.rows.item(0);	
		address.push(bus.Address); 	
        lats.push(bus.Latitude); 	
        longs.push(bus.Longitude); 
	}   
	
	//--------------------Add list Long Lat-----------------
	
	function addLongLatToBusStop()
	{
		var stop;

		for(var i = 0; i < longs.length; i++)
		{			
			stop = { 
            "Geometry": { 
               "Latitude": lats[i],
               "Longitude": longs[i]
            }};
            
       		 stops.push(stop);   			
		}	
	}
	
            function showDirection() 
			{
				    var map = new window.google.maps.Map(document.getElementById("map_canvas"));
				
				    // new up complex objects before passing them around
				    var directionsDisplay = new window.google.maps.DirectionsRenderer({suppressMarkers: true});// ko ve mac dinh cua Google
				    var directionsService = new window.google.maps.DirectionsService();
				
				    Tour_startUp(stops);
				
				    window.tour.loadMap(map, directionsDisplay);
				    window.tour.fitBounds(map);
				
				    if (stops.length > 1)
				        window.tour.calcRoute(directionsService, directionsDisplay);
			}
			
	function Tour_startUp(stops) {
		if (!window.tour) window.tour = {
			updateStops: function (newStops) {
				stops = newStops;
			},
			// map: google map object
			// directionsDisplay: google directionsDisplay object (comes in empty)
			loadMap: function (map, directionsDisplay) {
				var myOptions = {
					zoom: 13,
					center: new window.google.maps.LatLng(51.507937, -0.076188), // default to London
					mapTypeId: window.google.maps.MapTypeId.ROADMAP
				};
				map.setOptions(myOptions);
				directionsDisplay.setMap(map);
			},
			fitBounds: function (map) {
				var bounds = new window.google.maps.LatLngBounds();

				// extend bounds for each record
				jQuery.each(stops, function (key, val) {
					var myLatlng = new window.google.maps.LatLng(val.Geometry.Latitude, val.Geometry.Longitude);
					bounds.extend(myLatlng);
				});
				map.fitBounds(bounds);
			},
			calcRoute: function (directionsService, directionsDisplay) {
				var batches = [];
				var itemsPerBatch = 10; // google API max = 10 - 1 start, 1 stop, and 8 waypoints
				var itemsCounter = 0;
				var wayptsExist = stops.length > 0;

				while (wayptsExist) {
					var subBatch = [];
					var subitemsCounter = 0;

					for (var j = itemsCounter; j < stops.length; j++) {
						subitemsCounter++;
						subBatch.push({
							location: new window.google.maps.LatLng(stops[j].Geometry.Latitude, stops[j].Geometry.Longitude),
							stopover: true
						});
						if (subitemsCounter == itemsPerBatch)
							break;
					}

					itemsCounter += subitemsCounter;
					batches.push(subBatch);
					wayptsExist = itemsCounter < stops.length;
					// If it runs again there are still points. Minus 1 before continuing to
					// start up with end of previous tour leg
					itemsCounter--;
				}

				// now we should have a 2 dimensional array with a list of a list of waypoints
				var combinedResults;
				var unsortedResults = [{}]; // to hold the counter and the results themselves as they come back, to later sort
				var directionsResultsReturned = 0;

				for (var k = 0; k < batches.length; k++) {
					var lastIndex = batches[k].length - 1;
					var start = batches[k][0].location;
					var end = batches[k][lastIndex].location;

					// trim first and last entry from array
					var waypts = [];
					waypts = batches[k];
					waypts.splice(0, 1);
					waypts.splice(waypts.length - 1, 1);

					var request = {
						origin: start,
						destination: end,
						waypoints: waypts,
						travelMode: window.google.maps.TravelMode.DRIVING
					};
					(function (kk) {
						directionsService.route(request, function (result, status) {
							if (status == window.google.maps.DirectionsStatus.OK) {

								var unsortedResult = { order: kk, result: result };
								unsortedResults.push(unsortedResult);

								directionsResultsReturned++;

								if (directionsResultsReturned == batches.length) // we've received all the results. put to map
								{
									// sort the returned values into their correct order
									unsortedResults.sort(function (a, b) { return parseFloat(a.order) - parseFloat(b.order); });
									var count = 0;
									for (var key in unsortedResults) {
										if (unsortedResults[key].result != null) {
											if (unsortedResults.hasOwnProperty(key)) {
												if (count == 0) // first results. new up the combinedResults object
													combinedResults = unsortedResults[key].result;
												else {
													// only building up legs, overview_path, and bounds in my consolidated object. This is not a complete
													// directionResults object, but enough to draw a path on the map, which is all I need
													combinedResults.routes[0].legs = combinedResults.routes[0].legs.concat(unsortedResults[key].result.routes[0].legs);
													combinedResults.routes[0].overview_path = combinedResults.routes[0].overview_path.concat(unsortedResults[key].result.routes[0].overview_path);

													combinedResults.routes[0].bounds = combinedResults.routes[0].bounds.extend(unsortedResults[key].result.routes[0].bounds.getNorthEast());
													combinedResults.routes[0].bounds = combinedResults.routes[0].bounds.extend(unsortedResults[key].result.routes[0].bounds.getSouthWest());
												}
												count++;
											}
										}
									}
									
									directionsDisplay.setDirections(combinedResults);
									
									var legs = combinedResults.routes[0].legs;
									
									//Info Window
									for (var i=0; i < legs.length;i++){
									
										var title;
										if(i==0)
										{
											title = "Start BusStop";
										}else{
											title = "BusStop Number "+ i;
										}
										
										//0: map
										//1: postion
										//2: title
										//3: content + Dia chi
										//legs[i].start_address
										createMarker(directionsDisplay.getMap(),legs[i].start_location,title,address[i],i);
																			
										distance += legs[i].distance.value;
										duration += legs[i].duration.value;
										
									}              
									
									distance = distance/1000;
									duration = parseInt(duration/60);
										
									document.getElementById('directions').innerHTML += "<b>Khoảng cách</b>: " + distance + " (km)" + "<br>" 
									+ "<b>Thời gian đi</b>: " + duration + " (phút)";
									
									var i=legs.length;	     
									
									//Info Window END marker
									//legs[legs.length-1].end_address
									createMarkerEnd(directionsDisplay.getMap(),legs[legs.length-1].end_location,"End Bus STop",address[i],i);
									
								}
							}
						});
					})(k);
				}
			}
		};
	}

	var infowindow = new google.maps.InfoWindow(
	  { 
		size: new google.maps.Size(150,50)
	  });

	var icons = new Array();

	//Icon Thay the khi Icon Khac KHong Dinh NGhia
	icons["blank"] = new google.maps.MarkerImage("icon/blank.png",
		  // This marker is 20 pixels wide by 34 pixels tall.
		  new google.maps.Size(20, 34),
		  // The origin for this image is 0,0.
		  new google.maps.Point(0,0),
		  // The anchor for this image is at 9,34.
		  new google.maps.Point(9, 34));

	// Icons form Google API...

	   
	 function getMarkerImage(i) {
	   if ((typeof(i)=="undefined") || (i==null)) { 
		   i = "blank"; 
	   }
	   if (!icons[i]) {
	   
			if(i==0)
			{
				icons[i] = new google.maps.MarkerImage("http://www.google.com/mapfiles/dd-start.png",
			  new google.maps.Size(20, 34), new google.maps.Point(0,0),
			  new google.maps.Point(9, 34));
			}else{
			  icons[i] = new google.maps.MarkerImage("icon/marker"+ i +".png",
			  new google.maps.Size(20, 34), new google.maps.Point(0,0),
			  new google.maps.Point(9, 34));
		  }
		  
		  
	   } 
	   return icons[i];

	}
		  
	function getMarkerImageEnd(i) {
		 if ((typeof(i)=="undefined") || (i==null)) { 
			  i = "blank"; 
			}

	   if (!icons[i]) {
		  icons[i] = new google.maps.MarkerImage("http://www.google.com/mapfiles/dd-end.png",
		  // This marker is 20 pixels wide by 34 pixels tall.
		  new google.maps.Size(20, 34),
		  // The origin for this image is 0,0.
		  new google.maps.Point(0,0),
		  // The anchor for this image is at 6,20.
		  new google.maps.Point(9, 34));
	   } 
	   return icons[i];

	}


	  var iconImage = new google.maps.MarkerImage("icon/blank.png",
		  // This marker is 20 pixels wide by 34 pixels tall.
		  new google.maps.Size(20, 34),
		  // The origin for this image is 0,0.
		  new google.maps.Point(0,0),
		  // The anchor for this image is at 9,34.
		  new google.maps.Point(9, 34));
		  
		  
	  var iconShadow = new google.maps.MarkerImage('http://www.google.com/mapfiles/shadow50.png',
		  // The shadow image is larger in the horizontal dimension
		  // while the position and offset are the same as for the main image.
		  new google.maps.Size(37, 34),
		  new google.maps.Point(0,0),
		  new google.maps.Point(9, 34));
		  
		  
		  // Shapes define the clickable region of the icon.
		  // The type defines an HTML &lt;area&gt; element 'poly' which
		  // traces out a polygon as a series of X,Y points. The final
		  // coordinate closes the poly by connecting to the first
		  // coordinate.
	  var iconShape = {
		  coord: [9,0,6,1,4,2,2,4,0,8,0,12,1,14,2,16,5,19,7,23,8,26,9,30,9,34,11,34,11,30,12,26,13,24,14,21,16,18,18,16,20,12,20,8,18,4,16,2,15,1,13,0],
		  type: 'poly'
	  };


	function createMarker(map, latlng, label, html, color) {

		var contentString = '<b>'+label+'</b><br>'+html;
		var marker = new google.maps.Marker({
			position: latlng,
			map: map,
			shadow: iconShadow,
			icon: getMarkerImage(color),
			shape: iconShape,
			title: label,
			zIndex: Math.round(latlng.lat()*-100000)<<5
			});
			marker.myname = label;

		google.maps.event.addListener(marker, 'click', function() {
			infowindow.setContent(contentString); 
			infowindow.open(map,marker);
			});
			
			 // Close infoWindow when click in map
				     google.maps.event.addListener(map, 'click', function() {
			   				 infowindow.close();
			  			});
			  			
		return marker;
	}

	function createMarkerEnd(map, latlng, label, html, color) {

		var contentString = '<b>'+label+'</b><br>'+html;
		var marker = new google.maps.Marker({
			position: latlng,
			map: map,
			shadow: iconShadow,
			icon: getMarkerImageEnd(color),
			shape: iconShape,
			title: label,
			zIndex: Math.round(latlng.lat()*-100000)<<5
			});
			marker.myname = label;

		google.maps.event.addListener(marker, 'click', function() {
			infowindow.setContent(contentString); 
			infowindow.open(map,marker);
			});
		return marker;
	}

        </script>
    </head>
    <body>
        <div id="basic-map" data-role="page">
            <div data-role="header">
                <h1><b>Bus Direction</b></h1>
            </div>
            <div data-role="content">   
                <div class="ui-bar-c ui-corner-all ui-shadow" style="padding:1em;">
                    <div id="map_canvas" style="height:300px;"></div>
                </div>

                <a href="#" id="directions-button" data-role="button" data-inline="true" data-mini="true">Get Directions</a>
                
                <div id="results">
                    <p id="directions"></p>
                </div>
                
            </div>
        </div>      
    </body>
</html>